name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # backend-tests:
  #   name: Backend Tests
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: '8.0.x'

  #     - name: Restore dependencies
  #       run: dotnet restore
  #       working-directory: ./PetFoodVerifAI.Tests

  #     - name: Build
  #       run: dotnet build --no-restore
  #       working-directory: ./PetFoodVerifAI.Tests

  #     - name: Run tests
  #       run: dotnet test --no-build --verbosity normal --collect:"XPlat Code Coverage"
  #       working-directory: ./PetFoodVerifAI.Tests

  #     - name: Upload coverage reports
  #       if: always()
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: ./PetFoodVerifAI.Tests/TestResults/*/coverage.cobertura.xml
  #         flags: backend
  #         name: backend-coverage

  # frontend-unit-tests:
  #   name: Frontend Unit Tests
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: ./frontend
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: './frontend/package-lock.json'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Run unit tests with coverage
  #       run: npm run test:coverage

  #     - name: Upload coverage reports
  #       if: always()
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: ./frontend/coverage/lcov.info
  #         flags: frontend
  #         name: frontend-coverage

  #     - name: Archive coverage report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: frontend-coverage-report
  #         path: coverage/
  #         retention-days: 30

  # frontend-e2e-tests:
  #   name: Frontend E2E Tests
  #   runs-on: ubuntu-latest
  #   services:
  #     postgres:
  #       image: postgres:16
  #       env:
  #         POSTGRES_DB: petfoodverifai
  #         POSTGRES_USER: postgres
  #         POSTGRES_PASSWORD: postgres
  #       ports:
  #         - 5432:5432
  #       options: >-
  #         --health-cmd "pg_isready -U postgres"
  #         --health-interval 10s
  #         --health-timeout 5s
  #         --health-retries 5
  #   env:
  #     ASPNETCORE_ENVIRONMENT: Development
  #     ConnectionStrings__DefaultConnection: Host=127.0.0.1;Port=5432;Database=petfoodverifai;Username=postgres;Password=postgres
  #     AppUrl: http://127.0.0.1:5173
  #     UseMockLLM: 'true'
  #     Email__Resend__ApiKey: ${{ secrets.RESEND_API_KEY || 'test-e2e-key' }}
  #     Jwt__Key: ${{ secrets.JWT_KEY || 'set-a-secure-jwt-key' }}
  #     BASE_URL: http://127.0.0.1:5173
  #     VITE_API_URL: http://127.0.0.1:5135/api
  #     CI: 'true'
  #   defaults:
  #     run:
  #       working-directory: ./frontend
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup .NET
  #       uses: actions/setup-dotnet@v4
  #       with:
  #         dotnet-version: '8.0.x'

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: './frontend/package-lock.json'

  #     - name: Install dependencies
  #       run: npm ci

  #     - name: Install Playwright browsers
  #       run: npx playwright install chromium --with-deps

  #     - name: Install dotnet-ef tool
  #       run: dotnet tool install --global dotnet-ef

  #     - name: Restore backend dependencies
  #       run: dotnet restore
  #       working-directory: ./PetFoodVerifAI

  #     - name: Apply database migrations
  #       run: dotnet ef database update
  #       working-directory: ./PetFoodVerifAI

  #     - name: Build backend
  #       run: dotnet build --no-restore
  #       working-directory: ./PetFoodVerifAI

  #     - name: Start backend API
  #       run: |
  #         dotnet run --no-build --urls http://0.0.0.0:5135 &
  #         echo "BACKEND_PID=$!" >> $GITHUB_ENV
  #       working-directory: ./PetFoodVerifAI

  #     - name: Wait for backend readiness
  #       run: |
  #         for i in {1..30}; do
  #           if curl -sf http://127.0.0.1:5135/api/health/database > /dev/null; then
  #             echo "Backend is ready"
  #             exit 0
  #           fi
  #           sleep 2
  #         done
  #         echo "Backend did not become ready in time" >&2
  #         exit 1

  #     - name: Run E2E tests
  #       run: npm run e2e
  #       env:
  #         VITE_API_URL: http://127.0.0.1:5135/api

  #     - name: Upload Playwright report
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 30

  #     - name: Upload test results
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-test-results
  #         path: test-results/
  #         retention-days: 30

  #     - name: Stop backend API
  #       if: always() && env.BACKEND_PID != ''
  #       run: kill $BACKEND_PID || true

  # lint:
  #   name: Lint
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #         cache-dependency-path: './frontend/package-lock.json'

  #     - name: Install dependencies
  #       run: npm ci
  #       working-directory: ./frontend

  #     - name: Run linter
  #       run: npm run lint
  #       working-directory: ./frontend

  # ============================================
  # Deploy Backend API to Azure
  # ============================================
  deploy-backend:
    name: Deploy Backend to Azure
    runs-on: ubuntu-latest
    # needs: [backend-tests, frontend-unit-tests, frontend-e2e-tests, lint]
    # Only deploy on pushes to main branch (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore
        working-directory: ./PetFoodVerifAI

      - name: Build
        run: dotnet build --configuration Release --no-restore
        working-directory: ./PetFoodVerifAI

      - name: Publish
        run: dotnet publish --configuration Release --no-build --output ./publish
        working-directory: ./PetFoodVerifAI

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Web App
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'petfoodverifai-api'
          package: ./PetFoodVerifAI/publish

      - name: Logout from Azure
        if: always()
        run: az logout

      - name: Check deployment health
        run: |
          echo "Waiting 30 seconds for deployment to stabilize..."
          sleep 30
          echo "Checking health endpoint..."
          curl -f https://petfoodverifai-api-fjftbmfmbtfpgjh2.canadacentral-01.azurewebsites.net/api/health/database || echo "Health check failed, but deployment may still be in progress"

  # ============================================
  # Deploy Frontend to Azure Static Web Apps
  # ============================================
  deploy-frontend:
    name: Deploy Frontend to Azure Static Web Apps
    runs-on: ubuntu-latest
    # needs: [backend-tests, frontend-unit-tests, frontend-e2e-tests, lint]
    # Only deploy on pushes to main branch (not on PRs)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        run: npm ci
        working-directory: ./frontend

      - name: Build frontend
        run: npm run build
        working-directory: ./frontend
        env:
          VITE_API_URL: https://petfoodverifai-api-fjftbmfmbtfpgjh2.canadacentral-01.azurewebsites.net/api
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}

      - name: Ensure staticwebapp.config.json is in dist root
        run: |
          echo "Ensuring config file is in dist..."
          if [ -f "./frontend/public/staticwebapp.config.json" ]; then
            cp ./frontend/public/staticwebapp.config.json ./frontend/dist/staticwebapp.config.json
            echo "Copied from public/"
          elif [ -f "./frontend/staticwebapp.config.json" ]; then
            cp ./frontend/staticwebapp.config.json ./frontend/dist/staticwebapp.config.json
            echo "Copied from frontend root"
          fi
          echo "Verifying config file in dist:"
          cat ./frontend/dist/staticwebapp.config.json
          echo ""
          echo "Listing dist contents:"
          ls -la ./frontend/dist/

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "frontend"
          output_location: "dist"
          skip_app_build: true