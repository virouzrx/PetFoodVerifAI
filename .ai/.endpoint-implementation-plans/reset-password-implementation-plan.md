# API Endpoint Implementation Plan: Reset Password

## 1. Endpoint Overview

The `/api/auth/reset-password` endpoint allows users to reset their password using a security token sent to their email. This endpoint completes the password recovery flow initiated by the `/api/auth/forgot-password` endpoint. It validates the reset token, ensures it matches the provided email, and updates the user's password if all validations pass.

**Key Features:**
- Validates password reset tokens generated by ASP.NET Identity
- Ensures the token is associated with the provided email address
- Enforces password strength requirements
- Single-use tokens (token becomes invalid after successful password reset)
- Time-limited tokens (tokens expire after a configured duration)

## 2. Request Details

- **HTTP Method**: POST
- **URL Structure**: `/api/auth/reset-password`
- **Content-Type**: `application/json`
- **Authentication**: Not required (this is a public endpoint)

### Parameters

**Required:**
- `email` (string): The user's email address (must be valid email format)
- `token` (string): The password reset token received via email (URL-safe string)
- `newPassword` (string): The new password (must meet configured password requirements)

**Optional:** None

### Request Body Structure

```json
{
  "email": "user@example.com",
  "token": "CfDJ8K...",
  "newPassword": "NewSecurePassword123!"
}
```

### Validation Rules

- **Email**: 
  - Required
  - Must be valid email format
- **Token**: 
  - Required
  - Non-empty string
- **NewPassword**: 
  - Required
  - Must meet ASP.NET Identity password requirements:
    - Minimum length (configured in Identity options)
    - Requires uppercase letter
    - Requires lowercase letter
    - Requires digit
    - Requires special character (if configured)

## 3. Used Types

### DTOs (New)

**ResetPasswordRequestDto.cs** (to be created):
```csharp
public class ResetPasswordRequestDto
{
    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;

    [Required]
    public string Token { get; set; } = string.Empty;

    [Required]
    [DataType(DataType.Password)]
    public string NewPassword { get; set; } = string.Empty;
}
```

### DTOs (Existing)

- **AuthResultDto**: Used by service layer to return operation result
- **IdentityError**: Contains error details from Identity operations

### Service Interface Update

**IAuthService.cs** (to be updated):
```csharp
Task<AuthResultDto> ResetPasswordAsync(ResetPasswordRequestDto request);
```

## 4. Response Details

### Success Response (200 OK)

**Status Code**: 200 OK  
**Response Body**: Empty

```json
{}
```

**When Returned:**
- Password was successfully reset
- User can now log in with their new password

### Error Responses

#### 400 Bad Request

**Scenarios:**
1. Invalid email format
2. Missing required fields
3. Password doesn't meet strength requirements
4. Token is invalid or expired
5. Email doesn't match the token
6. User with provided email doesn't exist

**Response Body Structure:**
```json
{
  "errors": [
    {
      "code": "InvalidToken",
      "description": "Invalid or expired password reset token."
    }
  ]
}
```

**Common Error Messages:**
- "Email is required."
- "Please enter a valid email address."
- "Token is required."
- "New password is required."
- "Password must be at least X characters long."
- "Password must contain an uppercase letter, lowercase letter, digit, and special character."
- "Invalid or expired password reset token."
- "The provided email does not match the token."

#### 500 Internal Server Error

**Scenarios:**
- Database connection failure
- Unexpected server exception

**Response Body:**
```json
{
  "message": "An unexpected error occurred."
}
```

## 5. Data Flow

### Sequence Diagram

```
Client → Controller → Service → UserManager → Database
                                      ↓
Client ← Controller ← Service ← UserManager
```

### Detailed Flow

1. **Request Reception**
   - Client sends POST request with email, token, and newPassword
   - Controller receives request and validates model state

2. **Model Validation**
   - `[ApiController]` attribute triggers automatic model validation
   - Checks for required fields, email format
   - Returns 400 if validation fails

3. **Service Layer Processing**
   - Controller calls `AuthService.ResetPasswordAsync()`
   - Service retrieves user by email using `UserManager.FindByEmailAsync()`
   - If user not found, return generic error (security best practice)

4. **Token Validation**
   - Service calls `UserManager.ResetPasswordAsync()` with user, token, and new password
   - ASP.NET Identity validates:
     - Token format and signature
     - Token expiration
     - Token association with user
     - Password strength requirements

5. **Password Update**
   - If validation succeeds, Identity hashes the new password
   - Updates user's password hash in database
   - Updates user's security stamp (invalidates other tokens/sessions)
   - Commits transaction to database

6. **Response Generation**
   - Service returns `AuthResultDto` with success/failure status
   - Controller maps to appropriate HTTP response
   - Returns 200 OK on success, 400 Bad Request on failure

### Database Interaction

- **Tables Accessed**: `AspNetUsers`
- **Operations**: Read (find user), Update (password hash, security stamp)
- **Transaction**: Handled automatically by Entity Framework and Identity

## 6. Security Considerations

### Authentication & Authorization
- **Public Endpoint**: No authentication required (users resetting password don't have valid credentials)
- **Token-Based Security**: Security enforced through cryptographically secure tokens

### Token Security
- **Generation**: Tokens generated by ASP.NET Identity's `GeneratePasswordResetTokenAsync()`
- **Cryptographic Security**: Tokens are data protection tokens (encrypted and signed)
- **Expiration**: Configurable lifetime (typically 24 hours)
- **Single-Use**: Token invalidated after successful use (security stamp changes)
- **URL-Safe**: Tokens should be URL-encoded when sent in emails

### Password Security
- **Strength Requirements**: Enforced by Identity configuration
- **Hashing**: Passwords hashed using PBKDF2 with salt (Identity default)
- **No Plaintext**: Passwords never stored or logged in plaintext

### Security Validations

1. **User Existence Check**
   - Verify user exists before processing token
   - Return generic error if not found (prevent user enumeration)

2. **Email-Token Binding**
   - Verify provided email matches user associated with token
   - Prevents using stolen tokens with different email

3. **Token Integrity**
   - ASP.NET Identity validates token signature
   - Ensures token wasn't tampered with

4. **Rate Limiting Considerations**
   - Consider implementing rate limiting to prevent brute force attacks
   - Limit number of reset attempts per IP/email (not implemented in MVP but recommended)

### Logging & Monitoring

**Log Security Events:**
- Failed password reset attempts
- Invalid token usage
- Successful password resets

**Don't Log:**
- Password values (new or old)
- Token values
- Personally identifiable information in error logs

## 7. Error Handling

### Error Categories and Handling Strategy

#### 1. Validation Errors (400 Bad Request)

**Handled By**: Model validation + Service layer

**Examples:**
- Invalid email format → Automatic model validation
- Missing required fields → Automatic model validation
- Weak password → Identity validation
- Invalid token → Identity validation

**Response Format**:
```json
{
  "errors": [
    {
      "code": "ErrorCode",
      "description": "Human-readable error message"
    }
  ]
}
```

#### 2. Business Logic Errors (400 Bad Request)

**Handled By**: Service layer

**Examples:**
- User not found
- Token doesn't match email
- Token expired

**Strategy**: Return generic error messages to prevent information disclosure

#### 3. Server Errors (500 Internal Server Error)

**Handled By**: Global exception handler middleware

**Examples:**
- Database connection failures
- Unexpected exceptions

**Strategy**: 
- Log full exception details
- Return generic error to client
- Monitor and alert on 500 errors

### Error Response Mapping

| Scenario | HTTP Code | Error Message |
|----------|-----------|---------------|
| Invalid email format | 400 | "Please enter a valid email address." |
| Missing email | 400 | "The Email field is required." |
| Missing token | 400 | "The Token field is required." |
| Missing newPassword | 400 | "The NewPassword field is required." |
| Weak password | 400 | Identity-specific message (e.g., "Passwords must be at least 6 characters.") |
| Invalid/expired token | 400 | "Invalid or expired password reset token." |
| User not found | 400 | "Invalid or expired password reset token." (generic for security) |
| Database error | 500 | "An unexpected error occurred." |

### Logging Strategy

```csharp
// Log successful resets
_logger.LogInformation("Password reset successful for user {Email}", email);

// Log failed attempts (without sensitive data)
_logger.LogWarning("Failed password reset attempt for email {Email}. Reason: {Reason}", 
    email, "Invalid token");

// Log exceptions
_logger.LogError(ex, "Unexpected error during password reset for email {Email}", email);
```

## 8. Performance Considerations

### Expected Performance
- **Response Time**: < 500ms under normal load
- **Database Queries**: 2 queries (find user, update user)
- **Concurrency**: Low (password resets are infrequent)

### Potential Bottlenecks
1. **Database Lookups**: User retrieval by email
2. **Password Hashing**: Computationally expensive (by design)
3. **Token Validation**: Cryptographic operations

### Optimization Strategies
1. **Database Indexing**: Email column already indexed by Identity
2. **Connection Pooling**: Handled by Entity Framework
3. **Asynchronous Operations**: Use async/await throughout
4. **Caching**: Not applicable (security-sensitive operation)

### Load Considerations
- Password resets are infrequent, so load should be minimal
- If high load occurs, consider:
  - Rate limiting per IP/email
  - CAPTCHA for repeated attempts
  - Queue-based processing for emails

## 9. Implementation Steps

### Step 1: Create DTO
**File**: `PetFoodVerifAI/DTOs/AuthDtos.cs`

**Action**: Add `ResetPasswordRequestDto` class to existing AuthDtos.cs file

```csharp
public class ResetPasswordRequestDto
{
    [Required]
    [EmailAddress]
    public string Email { get; set; } = string.Empty;

    [Required]
    public string Token { get; set; } = string.Empty;

    [Required]
    [DataType(DataType.Password)]
    public string NewPassword { get; set; } = string.Empty;
}
```

**Validation**: 
- Compile code to ensure no syntax errors
- Verify namespace is correct

---

### Step 2: Update Service Interface
**File**: `PetFoodVerifAI/Services/IAuthService.cs`

**Action**: Add method signature for password reset

```csharp
Task<AuthResultDto> ResetPasswordAsync(ResetPasswordRequestDto request);
```

**Validation**:
- Ensure method signature follows naming conventions
- Verify return type consistency with other auth methods

---

### Step 3: Implement Service Logic
**File**: `PetFoodVerifAI/Services/AuthService.cs`

**Action**: Implement `ResetPasswordAsync` method

```csharp
public async Task<AuthResultDto> ResetPasswordAsync(ResetPasswordRequestDto request)
{
    // Find user by email
    var user = await _userManager.FindByEmailAsync(request.Email);
    if (user == null)
    {
        // Return generic error for security (don't reveal if email exists)
        return new AuthResultDto 
        { 
            Succeeded = false, 
            Errors = new[] { new IdentityError { Description = "Invalid or expired password reset token." } } 
        };
    }

    // URL-decode the token in case it arrives URL-encoded
    var decodedToken = Uri.UnescapeDataString(request.Token);
    
    // Reset password using UserManager
    var result = await _userManager.ResetPasswordAsync(user, decodedToken, request.NewPassword);
    
    if (!result.Succeeded)
    {
        // Try with the raw token if decode didn't help
        if (decodedToken != request.Token)
        {
            result = await _userManager.ResetPasswordAsync(user, request.Token, request.NewPassword);
        }
        
        if (!result.Succeeded)
        {
            return new AuthResultDto
            {
                Succeeded = false,
                Errors = result.Errors.Any() 
                    ? result.Errors 
                    : new[] { new IdentityError { Description = "Invalid or expired password reset token." } }
            };
        }
    }

    // Log successful reset
    System.Diagnostics.Debug.WriteLine($"Password reset successful for user {request.Email}");
    
    return new AuthResultDto
    {
        Succeeded = true,
        Response = new AuthResponseDto()
    };
}
```

**Validation**:
- Test with valid token from forgot-password flow
- Test with expired token
- Test with invalid token
- Test with wrong email
- Test with weak password

---

### Step 4: Add Controller Endpoint
**File**: `PetFoodVerifAI/Controllers/AuthController.cs`

**Action**: Add reset-password endpoint

```csharp
[HttpPost("reset-password")]
public async Task<IActionResult> ResetPassword([FromBody] ResetPasswordRequestDto request)
{
    if (!ModelState.IsValid)
    {
        return BadRequest(ModelState);
    }

    var result = await _authService.ResetPasswordAsync(request);

    if (!result.Succeeded)
    {
        return BadRequest(new { Errors = result.Errors });
    }

    return Ok();
}
```

**Validation**:
- Verify route matches API specification (`/api/auth/reset-password`)
- Ensure HTTP method is POST
- Check model binding and validation work correctly

---

### Step 5: Test the Endpoint

**Manual Testing Steps:**

1. **Setup**: Ensure forgot-password endpoint is working and sends emails

2. **Test Valid Flow**:
   - Call `/api/auth/forgot-password` with valid email
   - Retrieve reset token from email
   - Call `/api/auth/reset-password` with email, token, and new password
   - Verify 200 OK response
   - Verify can login with new password

3. **Test Invalid Token**:
   - Call with invalid/expired token
   - Verify 400 Bad Request with appropriate error

4. **Test Email Mismatch**:
   - Use token from one email with different email
   - Verify 400 Bad Request

5. **Test Weak Password**:
   - Use password that doesn't meet requirements
   - Verify 400 Bad Request with password strength error

6. **Test Missing Fields**:
   - Call with missing email, token, or password
   - Verify 400 Bad Request with validation errors

7. **Test Invalid Email Format**:
   - Call with malformed email
   - Verify 400 Bad Request

**API Testing Tools:**
- Postman/Insomnia for manual testing
- Swagger UI (available in development mode)
- curl commands

**Example curl command:**
```bash
curl -X POST https://localhost:7000/api/auth/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "token": "CfDJ8K...",
    "newPassword": "NewSecurePassword123!"
  }'
```

---

### Step 6: Integration Testing (Optional but Recommended)

**Create Test File**: `PetFoodVerifAI.Tests/AuthServiceResetPasswordTests.cs`

**Test Cases**:
1. `ResetPassword_WithValidToken_ShouldSucceed`
2. `ResetPassword_WithInvalidToken_ShouldFail`
3. `ResetPassword_WithExpiredToken_ShouldFail`
4. `ResetPassword_WithNonExistentEmail_ShouldFail`
5. `ResetPassword_WithWeakPassword_ShouldFail`
6. `ResetPassword_AfterSuccessfulReset_TokenShouldBeInvalidated`

---

### Step 7: Update API Documentation

**File**: `.ai/api-plan.md`

**Action**: Verify `/api/auth/reset-password` endpoint documentation is accurate

**Update if necessary:**
- Confirm request/response formats match implementation
- Verify status codes are correct
- Add any implementation notes

---

### Step 8: Security Review Checklist

- [ ] Tokens are cryptographically secure
- [ ] Tokens expire after reasonable time period
- [ ] Tokens are single-use (invalidated after password reset)
- [ ] Email-token binding is validated
- [ ] Generic error messages don't reveal user existence
- [ ] Passwords are hashed, never stored in plaintext
- [ ] Password strength requirements are enforced
- [ ] Sensitive data not logged (passwords, tokens)
- [ ] No user enumeration vulnerabilities
- [ ] Consider rate limiting for production

---

### Step 9: Deployment Checklist

Before deploying to production:

- [ ] All tests pass
- [ ] Code reviewed by team member
- [ ] API documentation updated
- [ ] Logging is properly configured
- [ ] Error handling tested for all scenarios
- [ ] Integration with forgot-password endpoint verified
- [ ] Token expiration time configured appropriately
- [ ] Email service is working in production environment
- [ ] Database migrations applied (if any)
- [ ] Monitoring and alerting configured
- [ ] Rate limiting considered/implemented

---

### Step 10: Post-Deployment Verification

After deployment:

1. **Smoke Test**: Verify endpoint is accessible
2. **End-to-End Test**: Complete full password reset flow
3. **Monitor Logs**: Check for unexpected errors
4. **Monitor Performance**: Verify response times are acceptable
5. **Security Scan**: Run security scanner if available
6. **User Acceptance**: Have stakeholder verify functionality

---

## 10. Additional Considerations

### Future Enhancements

1. **Rate Limiting**: Implement per-IP and per-email rate limiting
2. **CAPTCHA**: Add CAPTCHA for repeated failed attempts
3. **Two-Factor Authentication**: Require 2FA for password resets
4. **Audit Trail**: Log all password reset attempts for security auditing
5. **Email Notifications**: Notify users when password is changed
6. **Password History**: Prevent reusing recent passwords
7. **Account Lockout**: Lock account after multiple failed reset attempts

### Related Endpoints

This endpoint is part of the password recovery flow:
1. **POST `/api/auth/forgot-password`**: Initiates password reset (generates and sends token)
2. **POST `/api/auth/reset-password`**: Completes password reset (validates token and updates password)

Ensure both endpoints are implemented and tested together for complete flow validation.

### Configuration Requirements

Ensure the following are configured in `appsettings.json`:

```json
{
  "Identity": {
    "Tokens": {
      "PasswordResetTokenProvider": "Default",
      "PasswordResetTokenLifespan": "24:00:00"
    }
  }
}
```

Or in `Program.cs`:

```csharp
builder.Services.Configure<DataProtectionTokenProviderOptions>(options =>
{
    options.TokenLifespan = TimeSpan.FromHours(24);
});
```

---

## 11. References

- ASP.NET Identity Documentation: https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity
- Password Reset: https://docs.microsoft.com/en-us/aspnet/core/security/authentication/accconfirm
- Data Protection: https://docs.microsoft.com/en-us/aspnet/core/security/data-protection/
- OWASP Password Reset Guidelines: https://cheatsheetseries.owasp.org/cheatsheets/Forgot_Password_Cheat_Sheet.html

